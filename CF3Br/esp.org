* Electrostatic Potential Analysis

files used in this script:
CHGCAR & LOCPOT, both generated by jasp.
The last few lines in CHGCAR were discarded.

main sources:
dft-book
http://docs.enthought.com/mayavi/mayavi/auto/example_atomic_orbital.html#example-atomic-orbital

#+begin_src python

import numpy as np
from enthought.mayavi import mlab

# data below can be read from CHGCAR file.
nd = 96
a = 10.0

# Load the data, we need to remove the first 15 lines and the '\n'
str = ' '.join(file('CHGCAR').readlines()[15:])
rho_ravel = np.fromstring(str, sep=' ')
rho = np.empty((nd,nd,nd))
for i in xrange(nd):
  for j in xrange(nd):
    for k in xrange(nd):
      rho[k][j][i] = rho_ravel[k*nd*nd+j*nd+i]

#rho.shape = (nd, nd, nd)

str = ' '.join(file('LOCPOT').readlines()[15:])
esp_ravel = np.fromstring(str, sep=' ')
esp = np.empty((nd,nd,nd))
for i in xrange(nd):
  for j in xrange(nd):
    for k in xrange(nd):
      esp[k][j][i] = esp_ravel[k*nd*nd+j*nd+i]

#esp.shape = (nd, nd, nd)

mlab.figure(1, fgcolor=(1, 1, 1), bgcolor=(0, 0, 0))

# create a scalar field with the rho as the scalar
src = mlab.pipeline.scalar_field(rho)

# add the `esp` as an additional array
src.image_data.point_data.add_array(esp.ravel())#(esp_ravel) #(esp.T.ravel())

# give a name to our new dataset.
src.image_data.point_data.get_array(1).name = 'esp'

# The dataset should be up to date with the different arrays:
src.image_data.point_data.update()

# select the 'scalar' attribute
src2 = mlab.pipeline.set_active_attribute(src, point_scalars='scalar')

# Cut isosurfaces of the scalar
contour = mlab.pipeline.contour(src2)
contour.filter.contours = [50]

# select the 'esp' attribute,
contour2 = mlab.pipeline.set_active_attribute(contour, point_scalars='esp')

# display the surface. The colormap is the current attribute: the phase.
mlab.pipeline.surface(contour2, transparent=True)#, colormap='blue-red')

mlab.colorbar(title='ESP', orientation='vertical', nb_labels=21, nb_colors=21)
#mlab.view(azimuth=-225, elevation=180, distance='auto')

mlab.savefig('images/CF3Br-esp.png')

mlab.show()
#+end_src

#+RESULTS:

[[./images/CF3Br-esp.png]]
